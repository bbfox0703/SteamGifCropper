# SteamGifCropper

[繁體中文](./Readme.md) | [English](./Readme_en.md)

SteamGifCropper は **Steam ワークショップのショーケース** 用に作られた小さなツールです。GIF 画像を切り分けたり、調整して Steam プロフィールで横一列に表示できるようにします。GIF ファイルを扱うための補助機能も備えています。

---

## 機能

- **GIF の幅を確認** – ソース GIF の幅は **766px**（推奨）または **774px** に対応。
- **自動分割** – 設定済みの範囲に基づき 5 つに分割し、各パートの下に **100px** の透明領域を追加してもフレーム遅延を維持します。
- **透過と高さの調整** – 追加領域に同じ透明色を適用し、高さのバイト情報を復元します。
- **幅 766px にリサイズ** – 進捗表示付きで GIF を 766px にリサイズ。
- **末尾バイト切替ツール** – 複数の GIF の末尾バイトを `0x3B`/`0x21` に一括で切り替え。
- **5 個の GIF を統合して再分割** – 入力を約 153px に縮小し、長さを同期して共通パレットを作成。766px のプレビュー GIF を作成した後、ショーケース向けの 5 ファイルに再分割します。
- **2～5 個の GIF を横方向に結合** – リサイズせずに横並びで合成し、共通パレットの選択や FPS 差異の警告を行います。
- **GIF を連結＋トランジション** – 複数 GIF を 1 本にまとめ、FPS・サイズ・パレットを統一しながらフェード／スライド／ズーム／ディゾルブなどのトランジションを追加。
- **逆再生 GIF** – 逆再生バージョンを生成。
- **MP4 → GIF 変換** – FFmpeg を用いて開始時間と長さを指定した GIF を生成。
- **GIF の重ね合わせ** – 1 つの GIF を別の GIF の上に重ねて合成。
- **スクロールアニメーション** – 静止画または既存の GIF を対象に、方向・ステップ幅・ループ数・自動計算の周期を設定してスクロール GIF を作成。
- **GIF のリサイズとフレームレート変更** – FFmpeg（利用可能な場合）で幅・高さ・FPS を調整し、アスペクト比ロックも可能。
- **gifsicle サポート** – `gifsicle.exe` を呼び出してパレット最適化やロッシー圧縮、ディザ設定を実行。
- **リソース制限に対応** – Magick.NET のメモリ／ディスク制限を尊重し、システムリソースの枯渇を防止。
- **多言語 & テーマ対応** – 繁體中文・English・日本語の UI と、Windows のライト／ダーク テーマに対応。

---

## 動作環境

- **OS**: Windows 10 1904 以降
- **ランタイム**: .NET 8 runtime
- **ライブラリ**: Magick.NET（zip に同梱）
- **FFMPEG**: MP4 機能を利用する場合はインストールし、`PATH` に設定してください。
- **gifsicle.exe**: 別途ダウンロードし、`PATH` に設定してください。

---

## リソース制限と FFmpeg 設定

アプリは既定で Magick.NET のリソース制限を適用し、過剰な消費を防ぎます。

- メモリ: **1024 MB**
- ディスク キャッシュ: **4096 MB**

以下の方法で値を上書きできます。

1. **`App.config` を編集** – `<appSettings>` 内の `ResourceLimits.MemoryMB` と `ResourceLimits.DiskMB` を設定。
2. **コマンドライン引数** – `--memory-limit=<MB>` や `--disk-limit=<MB>` を指定して起動。

例:

```
SteamGifCropper.exe --memory-limit=2048 --disk-limit=8192
```

さらに `App.config` では FFmpeg の動作も調整できます。

- `FFmpeg.TimeoutSeconds` – 実行ごとのタイムアウト秒数（既定: 300）。
- `FFmpeg.Threads` – 使用するスレッド数を指定（`0` = FFmpeg の既定値）。

---

## 使い方

### 出力ファイル
分割後、5 つの GIF が次の名前で保存されます。
```
[元のファイル名]_Part1.gif
[元のファイル名]_Part2.gif
[元のファイル名]_Part3.gif
[元のファイル名]_Part4.gif
[元のファイル名]_Part5.gif
```
Steam にアップロードするには各ファイルのサイズを **5MB** 未満にしてください。必要に応じて調整や最適化を行ってください。

### リサイズ
リサイズ機能は簡易的なものです。大きな GIF ではメモリと時間を消費します。

### GIF の重ね合わせ
1. **Overlay GIF** ボタンを押して基となる GIF を選択します。
2. 重ねる GIF を選び、X/Y 位置を指定します。
3. OK を押すと 2 つの GIF が合成されます。

このダイアログは日本語・繁體中文・English に対応しており、ライト／ダーク テーマでも動作します。
**注意:** 高解像度の GIF を重ねると多くのメモリを消費する場合があります。

### 2～5 個の GIF を結合
元の幅のまま横方向に結合し、共通パレットの生成（高速モードあり）や FPS 差異の警告を行います。

### 5 個の GIF を 1 つの 766px GIF に結合
約 153px に縮小して同期・結合し、766px のプレビュー GIF を生成した後、再び 5 つのパーツに分割します。

### GIF を連結してトランジションを追加
1. **Concatenate GIFs** を押して 2 つ以上の GIF を選択。
2. FPS／サイズ／パレットの統一方法（自動、参照 GIF、カスタム）を設定。
3. トランジション（なし／フェード／スライド／ズーム／ディゾルブ）の種類・方向・時間を指定。
4. 高速パレットモードや出力後の gifsicle 最適化を必要に応じて有効化。

設定に応じて 1 本の連結 GIF を生成し、リソース制限を尊重して処理します。

### スクロール GIF
- **Scroll static image** – PNG・JPG などの静止画を対象に方向、ステップ幅、移動回数、フルサイクルの余白を指定してスクロール。
- **Scroll animated GIF** – GIF も読み込み可能で、自動計算を有効にすると 1 周の所要時間を推定します。

両機能とも、メイン画面の gifsicle チェックを有効にすれば最適化を同時に実行できます。

---

## 分割範囲 – **766px**
**150px** 幅、**4px** の隙間

| 部分 | X 範囲 |
|------|---------|
| Part 1 | 0 – 149 |
| Part 2 | 153 – 303 |
| Part 3 | 307 – 457 |
| Part 4 | 461 – 611 |
| Part 5 | 615 – 末尾 |

## 分割範囲 – **774px**
**150px** 幅、**6px** の隙間

| 部分 | X 範囲 |
|------|---------|
| Part 1 | 0 – 149 |
| Part 2 | 155 – 305 |
| Part 3 | 311 – 461 |
| Part 4 | 467 – 617 |
| Part 5 | 623 – 末尾 |

---

## 注意事項

1. ソース GIF の幅は **766px** または **774px** である必要があります。
1. 出力形式は GIF のみで、分割範囲や高さは固定です。
1. Steam のショーケース要件を満たし、各ファイルが 5MB 未満であることを確認してください。
1. 大きな GIF を処理するとメモリを大量に消費する場合があります。
1. 主に 766×432 と 766×353 の GIF でテストされています。

## 既知の問題

- すべての GIF を確実に処理できるわけではありません。
- すべての GIF 作成ツールとの互換性は保証されていません。
- 分割した画像の端に細い黒線が出ることがあります。

---

## 参考: 766px 時のアスペクト比
| 比率 | 出力サイズ (px) |
|------|----------------|
| 4:3    | 766 × 575 |
| 16:9   | 766 × 431 |
| 16:10  | 766 × 479 |
| 19.5:9 | 766 × 353 |
| 21:9   | 766 × 329 |

